name: ðŸš€ Release

on:
  push:
    tags:
      - "16.*"

permissions:
  id-token: write
  contents: read

jobs:
  release:
    name: ðŸ“¦ Build & Publish NuGet Packages
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    steps:
      - name: ðŸ“¦ Checkout
        uses: actions/checkout@v4
        with:
          show-progress: false

      - name: ðŸ›  Install .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            8.x
            9.x
            10.x

      - name: ðŸ· Get the version from tag
        id: get_version
        run: echo "GIT_TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV

      - name: ðŸ“¦ Build NuGet Packages
        run: |
          ./build.sh pack --SemVersion ${{ env.GIT_TAG }} --Configuration Release
        env:
          NitroApiClientId: ${{ secrets.NITRO_API_CLIENT_ID }}
          NitroIdentityClientId: ${{ secrets.NITRO_IDENTITY_CLIENT_ID }}
          NitroIdentityScopes: ${{ secrets.NITRO_IDENTITY_SCOPES }}

      - name: ðŸ“¦ Publish Nitro CLI client
        run: |
          ./build.sh UploadNitroClient --SemVersion ${{ env.GIT_TAG }}
          ./build.sh PublishNitroClient --SemVersion ${{ env.GIT_TAG }}
        env:
          NitroApiClientId: ${{ secrets.NITRO_API_CLIENT_ID }}
          NitroApiKey: ${{ secrets.NITRO_API_KEY }}

      - name: ðŸš€ Push Packages to NuGet
        run: |
          ./build.cmd publish --skip
        env:
          NuGetApiKey: ${{ secrets.NUGETAPIKEY }}

      - name: ðŸ”Ž Get GitHub Release Info
        id: get_release
        run: |
          RELEASE_ID=$(gh api repos/ChilliCream/graphql-platform/releases/tags/${{ env.GIT_TAG }} --jq '.id')
          UPLOAD_URL=$(gh api repos/ChilliCream/graphql-platform/releases/$RELEASE_ID --jq '.upload_url')
          echo "RELEASE_ID=$RELEASE_ID" >> $GITHUB_ENV
          echo "UPLOAD_URL=${UPLOAD_URL}" >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“¤ Upload .nupkg Release Assets
        run: |
          for file in ./output/packages/*.nupkg; do
            echo "ðŸ“¤ Uploading $file"
            gh release upload ${{ env.GIT_TAG }} "$file" --repo ChilliCream/graphql-platform
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-nitro-cli:
    name: ðŸ§± Build and Publish Nitro CLI
    runs-on: ${{ matrix.os }}
    # We need to depend on this job, as it publishes the persisted operations of the CLI.
    needs: release
    permissions:
      contents: write
    strategy:
      matrix:
        include:
          # Linux (x64)
          - os: ubuntu-22.04
            rid: linux-x64
          - os: ubuntu-22.04
            rid: linux-musl-x64
          # Linux (arm64 on ARM runner!)
          - os: ubuntu-24.04-arm
            rid: linux-arm64
          # macOS
          - os: macos-15
            rid: osx-x64
          - os: macos-15
            rid: osx-arm64
          # Windows
          - os: windows-2025
            rid: win-x64
          - os: windows-2025
            rid: win-x86
          # Windows (arm64 on ARM runner!)
          # - os: windows-11-arm
          #   rid: win-arm64

    steps:
      - name: ðŸ“¦ Checkout
        uses: actions/checkout@v4

      - name: ðŸ›  Install .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.x

      - name: ðŸ§© Publish AOT binary for ${{ matrix.rid }}
        shell: bash
        run: |
          dotnet publish ./src/Nitro/CommandLine/src/CommandLine \
            -c Release \
            -r ${{ matrix.rid }} \
            -f net10.0 \
            --self-contained true \
            -p:PublishAot=true \
            -p:TargetFrameworks=NET10.0 \
            -p:RuntimeIdentifiers=${{ matrix.rid }} \
            -o ./publish

      - name: ðŸ–‹ï¸ Azure login (for Windows)
        uses: azure/login@v1
        if: runner.os == 'Windows'
        with:
          creds: ${{ secrets.SIGNING_CREDENTIALS }}

      - name: ðŸ–‹ï¸ Sign Windows binary
        uses: azure/trusted-signing-action@v0
        if: runner.os == 'Windows'
        with:
          endpoint: ${{ vars.AZURE_TRUSTED_SIGNING_ACCOUNT_ENDPOINT }}
          trusted-signing-account-name: ${{ secrets.AZURE_CODE_SIGNING_NAME }}
          certificate-profile-name: ${{ secrets.WINDOWS_APP_CERT_PROFILE_NAME }}
          files: ${{ github.workspace }}\publish\nitro.exe
          file-digest: SHA256
          timestamp-rfc3161: http://timestamp.acs.microsoft.com
          timestamp-digest: SHA256
          exclude-environment-credential: true
          exclude-workload-identity-credential: true
          exclude-managed-identity-credential: true
          exclude-shared-token-cache-credential: true
          exclude-visual-studio-credential: true
          exclude-visual-studio-code-credential: true
          exclude-azure-cli-credential: false
          exclude-azure-powershell-credential: true
          exclude-azure-developer-cli-credential: true
          exclude-interactive-browser-credential: true

      # https://docs.github.com/en/actions/how-tos/deploy/deploy-to-third-party-platforms/sign-xcode-applications
      - name: ðŸ–‹ï¸ Set up macOS signing resources
        if: runner.os == 'macOS'
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.APPLE_DEVELOPER_CERTFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.APPLE_DEVELOPER_CERTFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.TEMPORARY_KEYCHAIN_PASSWORD }}
        run: |
          # create variables
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          # import certificate from secrets
          echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH

          # create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # import certificate to keychain
          security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

      - name: ðŸ–‹ï¸ Sign macOS binary
        if: runner.os == 'macOS'
        env:
          CODESIGN_IDENTITY: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_IDENTITY }}
        run: |
          echo "Code signing 'publish/nitro'..."

          codesign --sign "$CODESIGN_IDENTITY" \
            --verbose=3 \
            --identifier "com.chillicream.nitro" \
            --options runtime \
            --timestamp \
            --force \
            publish/nitro

          codesign --verify --deep --strict --verbose=2 publish/nitro

      - name: ðŸ“¦ Zip binary (Windows)
        if: runner.os == 'Windows'
        run: |
          Compress-Archive -Path (Get-Item publish/nitro.exe) -DestinationPath nitro-${{ matrix.rid }}.zip
        shell: pwsh

      - name: ðŸ“¦ Zip binary (Unix)
        if: runner.os != 'Windows'
        run: |
          zip -j nitro-${{ matrix.rid }}.zip publish/nitro
        shell: bash

      - name: ðŸ–‹ï¸ Notarize macOS zipped binary
        if: runner.os == 'macOS'
        env:
          CODESIGN_IDENTITY: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_IDENTITY }}
          APPLE_DEVELOPER_ID_EMAIL: ${{ secrets.APPLE_DEVELOPER_ID_EMAIL }}
          APPLE_DEVELOPER_TEAM_ID: ${{ secrets.APPLE_DEVELOPER_TEAM_ID }}
          APPLE_DEVELOPER_NITRO_CLI_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_DEVELOPER_NITRO_CLI_APP_SPECIFIC_PASSWORD }}
        run: |
          echo "Code signing 'nitro-${{ matrix.rid }}.zip'..."

          codesign --sign "$CODESIGN_IDENTITY" \
            --verbose=3 \
            --options runtime \
            --timestamp \
            --force \
            nitro-${{ matrix.rid }}.zip

          codesign --verify --deep --strict --verbose=2 nitro-${{ matrix.rid }}.zip

          echo "Notarizing 'nitro-${{ matrix.rid }}.zip'..."

          xcrun notarytool submit nitro-${{ matrix.rid }}.zip \
            --apple-id "$APPLE_DEVELOPER_ID_EMAIL" \
            --team-id "$APPLE_DEVELOPER_TEAM_ID" \
            --password "$APPLE_DEVELOPER_NITRO_CLI_APP_SPECIFIC_PASSWORD" \
            --wait

          spctl --assess --type exec -vv nitro-${{ matrix.rid }}.zip || true
          codesign -dvv nitro-${{ matrix.rid }}.zip || true

      - name: ðŸ–‹ï¸ Clean up macOS signing resources
        if: always() && runner.os == 'macOS'
        run: |
          security delete-keychain $RUNNER_TEMP/app-signing.keychain-db

      - name: ðŸ“¤ Upload Zipped AOT binary as artifact
        uses: actions/upload-artifact@v4
        with:
          name: nitro-${{ matrix.rid }}
          path: nitro-${{ matrix.rid }}.zip

      - name: ðŸ“¤ Upload Zipped AOT binary to release
        shell: bash
        run: |
          gh release upload ${{ github.ref_name }} nitro-${{ matrix.rid }}.zip --repo ${{ github.repository }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-homebrew:
    name: ðŸº Update Homebrew Formula
    runs-on: ubuntu-latest
    needs: [build-nitro-cli]
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: ðŸ“¥ Checkout main repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ·ï¸ Get release version
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: â¬‡ï¸ Download macOS ARM64 release
        run: |
          curl -L -o nitro-osx-arm64.zip \
            "https://github.com/ChilliCream/graphql-platform/releases/download/${{ steps.version.outputs.version }}/nitro-osx-arm64.zip"

      - name: â¬‡ï¸ Download macOS x64 release
        run: |
          curl -L -o nitro-osx-x64.zip \
            "https://github.com/ChilliCream/graphql-platform/releases/download/${{ steps.version.outputs.version }}/nitro-osx-x64.zip"

      - name: ðŸ”¢ Calculate SHA256 hashes
        id: hashes
        run: |
          ARM64_SHA=$(sha256sum nitro-osx-arm64.zip | cut -d' ' -f1)
          X64_SHA=$(sha256sum nitro-osx-x64.zip | cut -d' ' -f1)
          echo "arm64_sha=$ARM64_SHA" >> $GITHUB_OUTPUT
          echo "x64_sha=$X64_SHA" >> $GITHUB_OUTPUT
          echo "ðŸ” ARM64 SHA: $ARM64_SHA"
          echo "ðŸ” X64 SHA: $X64_SHA"

      - name: ðŸ“ Generate Homebrew formula
        run: |
          cat > nitro-cli.rb << EOF
          class NitroCli < Formula
            desc "ChilliCream Nitro Command Line"
            homepage "https://chillicream.com"
            url "https://github.com/ChilliCream/graphql-platform"
            license "MIT"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/ChilliCream/graphql-platform/releases/download/${{ steps.version.outputs.version }}/nitro-osx-arm64.zip"
                sha256 "${{ steps.hashes.outputs.arm64_sha }}"
              else
                url "https://github.com/ChilliCream/graphql-platform/releases/download/${{ steps.version.outputs.version }}/nitro-osx-x64.zip"
                sha256 "${{ steps.hashes.outputs.x64_sha }}"
              end
            end

            def install
              bin.install "nitro"
            end

            test do
              system "#{bin}/nitro", "--version"
            end
          end
          EOF

      - name: ðŸ“¥ Checkout homebrew repo
        uses: actions/checkout@v4
        with:
          repository: ChilliCream/homebrew-tools
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tools

      - name: ðŸš€ Update formula in homebrew repo
        run: |
          cp nitro-cli.rb homebrew-tools/nitro-cli.rb
          cd homebrew-tools
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add nitro-cli.rb
          git commit -m "ðŸº Update nitro formula to ${{ steps.version.outputs.version }}" || exit 0
          git push