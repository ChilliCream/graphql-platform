<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <ItemDefinitionGroup>
    <GraphQL>
      <Generator>MSBuild:GraphQL_Compile</Generator>
    </GraphQL>
  </ItemDefinitionGroup>

  <ItemGroup>
    <PropertyPageSchema Include="$(GraphQLPropertyPageSchema)">
      <Context>File;BrowseObject</Context>
    </PropertyPageSchema>
    <AvailableItemName Include="GraphQL" />
  </ItemGroup>

  <!-- Extension points. -->
  <Target Name="GraphQL_BeforeCompile" />
  <Target Name="GraphQL_AfterCompile" />

  <!-- Main compile sequence. -->
  <Target Name="GraphQL_Compile" Condition="'@(GraphQL)' != ''"
    DependsOnTargets="GraphQL_BeforeCompile;
          GraphQL_CoreCompile;
          GraphQL_AfterCompile" />

  <Target Name="GraphQL_CoreCompile">
    <PropertyGroup>
      <BerryLangVersion Condition="'$(Nullable)'=='enable' AND '$(LangVersion)'=='8.0'">CSharp_8_0</BerryLangVersion>
      <BerryLangVersion Condition="'$(BerryLangVersion)'==''">CSharp_7_3</BerryLangVersion>
      <BerryEnableDI Condition="'$(BerryEnableDI)'==''">true</BerryEnableDI>
      <BerryNamespace Condition="'$(BerryNamespace)'=='' AND '$(RootNamespace)'!=''">$(RootNamespace)</BerryNamespace>
      <BerryCommand>dotnet graphql generate "$(MSBuildProjectDirectory)" -s</BerryCommand>
      <BerryCommand>$(BerryCommand) -l $(BerryLangVersion)</BerryCommand>
      <BerryCommand Condition="'$(BerryEnableDI)'=='true'">$(BerryCommand) -d</BerryCommand>
      <BerryCommand Condition="'$(BerryNamespace)'!=''">$(BerryCommand) -n $(BerryNamespace)</BerryCommand>
    </PropertyGroup>

    <Message Text="$(BerryCommand)" Importance="High" />
    <Exec Command="$(BerryCommand)" WorkingDirectory="$(MSBuildProjectDirectory)" IgnoreExitCode="true" />
  </Target>

  <Target Name="GraphQL_Environment_Validation" BeforeTargets="BeforeBuild">
    <Error Text="GraphQL content definition is missing." Condition="!Exists('$(GraphQLPropertyPageSchema)')" />
  </Target>

</Project>
